# jisui

自炊した画像を処理するためのツールです．

## Prerequisites

- Docker
  - Windows, Mac 環境では必須
  - Linux では [Go Imagick v2]() が動く環境であればビルド可能です
    - CentOS とかではデフォルトで v1 用のライブラリが入るため面倒です
  - Windows
    - https://docs.docker.com/docker-for-windows/install
    - Memo: Hyper-V を裏で使用
  - Mac
    - `brew install docker`
    - Memo: xhyve を裏で使用
  - Linux
    - https://docs.docker.com/engine/installation

## Installation

Clone repository (not `go get`).

```
git clone https://github.com/zuiurs/jisui.git
```

Building container.

```
cd jisui
make container
```

## Usage

Docker コンテナで動かすことを想定しているため若干使い方が特殊です．

クローンしたリポジトリに適当なデータ置き場を作成します．

```
mkdir work
# copy your comic data to work
```

コンテナを起動してその中で作業します．

```
make run
```

起動時に行われる作業は下記になります．起動直後からすぐ最新のコマンドが使えるようになっています．

- 現在のディレクトリのマウント
- ソースコードのコンパイル & インストール
- マウントポイントでの bash 起動

あとは普通に使ってください．

```
jisui
```

## Routine

自炊の流れを書いておきます．

1. 漫画のカバーと帯を取る
1. カバーと帯はシリーズまとめて ScanSnap iX500 のカバー用コンフィグでスキャン
1. Curl DC-200N で表紙折込，表紙 & 背表紙，裏表紙，裏表紙折込の 4 つに分割
1. 漫画本体を Durodex 200DX で裁断
  - 5mm くらいで攻めても大丈夫だが本体表紙の糊が付きやすい
  - 中央部分まで台詞がある漫画は多いため，攻めないと負ける
  - コツ: 本を固定したら裁断時に上から押さえつけながら素早く断つ．そうしないと切断部分が下に行くに従って多くなる．
  - コツ: 裁断後はパラパラすること．ページの付着を取り除かないとぐちゃぐちゃになる．
1. ScanSnap iX500 の漫画用コンフィグでスキャン
  - 表紙 & 背表紙 → 表紙折込 → 漫画本体 → 裏表折込 → 裏表紙
  - コツ: ずらして入れると 100 枚くらいスキャンできます
1. スキャン結果のディレクトリに移り，カバー系と漫画本体の表紙・裏表紙の裏面 (白紙) を手作業削除 (計 6 枚)
  - 漫画本体の表紙・裏表紙の裏面は本来カバーの折込にあたるため
1. 2. でスキャンした全体カバーと帯を適当に大きなナンバリングにして入れる
1. `jisui align <directory>` でゴミ削除，ナンバリング調整をする

この時点で Row なデータの取り込みは完了になります．コミカライズ用の手順は下記になります．

1. `jisui comic <directory>` で漫画用のデータに変換します
  - TODO: ここらへんの調整とかしやすくする

### Hardware

使用する機種は次の 3 つです．

- Durodex 200DX
  - https://www.amazon.co.jp/dp/B00A378TNU
- Curl DC-200N
  - https://www.amazon.co.jp/dp/B005GICA5Y
- ScanSnap iX500
  - https://www.amazon.co.jp/dp/B00T2B5L52

使用している機種のコンフィグです．

### ScanSnap iX500 Configuration

- 共通設定
  - アプリ選択
    - [アプリケーションの選択]: [起動しません(ファイル保存のみ)]
  - ファイル形式
    - [ファイル形式の選択]: [JPEG (\*.jpg)]
  - 原稿
    - [原稿サイズの選択]: [サイズ自動検出]
    - [マルチフィード検出]: [重なりで検出 (超音波)]
  - ファイルサイズ
    - [圧縮]: [1] 

- カバー・帯用設定
  - 保存先
    - [イメージの保存先]: `C:\path\to\cover\result`
    - ファイル名の設定
      - [*] [自分で名前をつけます]
      - [先頭文字列]: `title_`
      - [連番]: [1桁]
      - 例: shingeki_1.jpg
  - 読み取りモード
    - [画質の選択]: [スーパーファイン(カラー/グレー: 300dpi，白黒: 600dpi相当)]
    - [カラーモードの選択]: [カラー]
    - [読み取り面の選択]: [片面読み取り]
    - [向きの選択]: [回転しない]
    - [_] [白紙ページを自動的に削除します]
    - [*] [継続読み取りを有効にします]
    - [オプション] は全てチェックを外す

- 漫画本体用設定
  - 保存先
    - [イメージの保存先]: `C:\path\to\main\result`
    - ファイル名の設定
      - [*] [自分で名前をつけます]
      - [先頭文字列]: `title_number_`
      - [連番]: [3桁]
      - 例: shingeki_1_001.jpg
  - 読み取りモード
    - [画質の選択]: [エクセレント(カラー/グレー: 600dpi，白黒: 1200dpi相当)]
    - [カラーモードの選択]: [カラー]
    - [読み取り面の選択]: [両面読み取り]
    - [向きの選択]: [回転しない]
    - [_] [白紙ページを自動的に削除します]
    - [*] [継続読み取りを有効にします]
    - [オプション] は全てチェックを外す

## About /scripts

昔使っていた自炊用のシェルスクリプトです．Go のツールがあるため今はほとんど使いませんし，メンテもしたくないです．

ImageMagick を実行できる環境が必要です．

基本的に原本はカラーの最高画質，圧縮なしで取り込み，あとからこのスクリプト群で調整します．

### pack.sh

下記のフォーマットの連番で管理されているファイルの番号を切り詰めます．

フォーマット: 最長マッチでアンダースコアを検索．3 桁の 0 パディングされた連番のあとに拡張子がついているファイル．

```
.*_XXX\.jpg
```

両面で取り込んで表紙とかの裏の白紙を削除した時に，これで切り詰めます．

### gray.sh

グレースケールに変換します．

具体的には下記のことをやっています．

1. Red のチャネルを削除 (黄ばみの除去) し，グレースケール変換
1. ヒストグラムの 90% を白とする (紙のノイズを除去)
1. ヒストグラムの 35% を黒とする (ベタを黒塗りする)


